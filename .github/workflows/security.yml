name: Security

on:
  workflow_call:  # Can be called by other workflows

jobs:
  dependencies:
    name: üõ°Ô∏è Scan Dependencies
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Scan IAM dependencies
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: 'iam/requirements.txt'
        format: 'table'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'
    - name: Scan Gateway dependencies
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: 'gateway/requirements.txt'
        format: 'table'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'

  docker:
    name: üê≥ Scan Docker Images
    needs: dependencies
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Build IAM Docker image
      run: docker build -t iam:test -f deployment/docker/iam_dockerfile .
    - name: Scan IAM Docker image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'iam:test'
        format: 'table'
        exit-code: '1'
        severity: 'CRITICAL'
    - name: Build Gateway Docker image
      run: docker build -t gateway:test -f deployment/docker/gateway_dockerfile .
    - name: Scan Gateway Docker image
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'gateway:test'
        format: 'table'
        exit-code: '1'
        severity: 'CRITICAL'
