name: Tests

on:
  pull_request:
    branches:
      - main

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      iam: ${{ steps.filter.outputs.iam }}
      gateway: ${{ steps.filter.outputs.gateway }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          iam:
            - 'iam/**'
            - 'shared/**'
            - 'pytest.ini'
          gateway:
            - 'gateway/**'
            - 'shared/**'

  test-iam:
    needs: changes
    if: needs.changes.outputs.iam == 'true'
    name: Test IAM Service
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }}/iam/src:${{ github.workspace }}
      SERVER_URL: "http://127.0.0.1:9000"
      KEYCLOAK_FRONTEND_URL: "http://keycloak:9000"
      REALM: "templateRealm"
      CLIENT_ID: "templateApp"
      SCOPE: "openid"
      KC_BOOTSTRAP_ADMIN_USERNAME: "admin"
      KC_BOOTSTRAP_ADMIN_PASSWORD: "admin"
      IAM_PORT: "8081"
      IAM_HOST: "localhost"
      MONGO_CONNECTION_STRING: "mongodb://localhost:27017"
      DB_NAME: "templateApp"
      APP_EMAIL: "admin@example.com"
      APP_PASSWORD: "xxx xxx xxx"
      SYSTEM_ADMIN_USER_NAME: "sysadmin"
      SYSTEM_ADMIN_FIRST_NAME: "None"
      SYSTEM_ADMIN_LAST_NAME: "None"
      SYSTEM_ADMIN_EMAIL: "sysadmin@dev.com"
      SYSTEM_ADMIN_PASSWORD: "sysadminpassword"

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    - name: Install IAM dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r iam/requirements.txt
        pip install pytest pytest-asyncio mongomock
    - name: Run IAM Tests
      run: pytest iam/test
