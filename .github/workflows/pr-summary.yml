name: PR Summary

on:
  workflow_run:
    workflows: ["Lint", "Security", "Tests"]
    types:
      - completed

jobs:
  summary:
    name: PR Status Comment
    runs-on: ubuntu-latest
    if: github.event.workflow_run.event == 'pull_request'
    steps:
    - name: Post PR Comment
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          
          // Get the PR number from the workflow run
          const runId = context.payload.workflow_run.id;
          const headSha = context.payload.workflow_run.head_sha;
          
          // Find PR associated with this commit
          const prs = await github.rest.pulls.list({
            owner,
            repo,
            state: 'open',
            head: `${owner}:${context.payload.workflow_run.head_branch}`
          });
          
          if (prs.data.length === 0) {
            console.log('No open PR found');
            return;
          }
          
          const pr_number = prs.data[0].number;
          
          // Get all check runs for this commit
          const checks = await github.rest.checks.listForRef({
            owner,
            repo,
            ref: headSha,
          });
          
          const checkRuns = checks.data.check_runs.filter(
            run => run.name !== 'PR Status Comment'
          );
          
          const passed = checkRuns.filter(r => r.conclusion === 'success').length;
          const failed = checkRuns.filter(r => r.conclusion === 'failure').length;
          const pending = checkRuns.filter(r => !r.conclusion).length;
          const total = checkRuns.length;
          
          const allPassed = failed === 0 && pending === 0 && total > 0;
          
          // Only post comment when all checks have completed
          if (pending > 0) {
            console.log(`Still waiting for ${pending} checks`);
            return;
          }
          
          // Build comment
          let body = '';
          
          if (allPassed) {
            body = `## âœ… All CI Checks Passed!

| Status | Check | Duration |
|:------:|-------|----------|
`;
            for (const run of checkRuns) {
              const duration = run.completed_at 
                ? Math.round((new Date(run.completed_at) - new Date(run.started_at)) / 1000)
                : '-';
              body += `| âœ… | ${run.name} | ${duration}s |\n`;
            }
            
            body += `
---

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                             â”‚
â”‚   ğŸš€  READY TO MERGE                        â”‚
â”‚                                             â”‚
â”‚   âœ“ Lint      Â· No unused imports           â”‚
â”‚   âœ“ Security  Â· No vulnerabilities          â”‚
â”‚   âœ“ Tests     Â· All tests passing           â”‚
â”‚                                             â”‚
â”‚   Checks: ${passed}/${total} passed                       â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

> ğŸ‰ **This PR is ready for review and merge!**

<sub>ğŸ¤– Automated CI Summary</sub>`;
          } else {
            body = `## âŒ Some CI Checks Failed

| Status | Check |
|:------:|-------|
`;
            for (const run of checkRuns) {
              const icon = run.conclusion === 'success' ? 'âœ…' : 'âŒ';
              body += `| ${icon} | ${run.name} |\n`;
            }
            
            body += `
---

> âš ï¸ **Please fix the failing checks before merging.**

<sub>ğŸ¤– Automated CI Summary</sub>`;
          }
          
          // Find existing bot comment to update
          const comments = await github.rest.issues.listComments({
            owner,
            repo,
            issue_number: pr_number,
          });
          
          const botComment = comments.data.find(
            c => c.body.includes('ğŸ¤– Automated CI Summary')
          );
          
          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner,
              repo,
              comment_id: botComment.id,
              body: body
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: body
            });
          }
