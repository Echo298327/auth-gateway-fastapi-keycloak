name: Summary

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write
  checks: read

jobs:
  post-summary:
    name: Post Summary
    runs-on: ubuntu-latest
    steps:
    - name: Wait for other checks
      run: sleep 90
      
    - name: Post CI Summary
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request.number;
          const { owner, repo } = context.repo;
          const sha = context.payload.pull_request.head.sha;
          
          // Poll for checks to complete
          let attempts = 0;
          let runs = [];
          
          while (attempts < 20) {
            const checks = await github.rest.checks.listForRef({
              owner, repo, ref: sha
            });
            
            runs = checks.data.check_runs.filter(r => r.name !== 'Post Summary');
            const pending = runs.filter(r => !r.conclusion).length;
            
            if (pending === 0 && runs.length >= 4) break;
            
            await new Promise(r => setTimeout(r, 15000));
            attempts++;
          }
          
          if (runs.length === 0) return;
          
          const passed = runs.filter(r => r.conclusion === 'success').length;
          const failed = runs.filter(r => r.conclusion === 'failure').length;
          const total = runs.length;
          
          const getIcon = (status) => {
            if (status === 'success') return '✅';
            if (status === 'failure') return '❌';
            if (status === 'skipped') return '⏭️';
            return '⏳';
          };
          
          let body = '';
          
          if (failed === 0) {
            body = `## ✅ All CI Checks Passed!

| Status | Check | Duration |
|:------:|-------|----------|
`;
            for (const r of runs) {
              const d = r.completed_at ? Math.round((new Date(r.completed_at) - new Date(r.started_at)) / 1000) + 's' : '-';
              body += `| ${getIcon(r.conclusion)} | ${r.name} | ${d} |\n`;
            }
            
            body += `
---

\`\`\`
┌─────────────────────────────────────────────┐
│                                             │
│   READY TO MERGE                            │
│                                             │
│   * Lint        - No unused imports         │
│   * Security    - No vulnerabilities        │
│   * Tests       - All tests passing         │
│                                             │
│   Checks: ${passed}/${total} passed                       │
│                                             │
└─────────────────────────────────────────────┘
\`\`\`

> **This PR is ready for review and merge!**
`;
          } else {
            body = `## ❌ CI Checks Failed

| Status | Check |
|:------:|-------|
`;
            for (const r of runs) {
              body += `| ${getIcon(r.conclusion)} | ${r.name} |\n`;
            }
            
            body += `
---

> **Please fix the failing checks before merging.**
`;
          }
          
          body += `\n<sub>Automated CI Summary</sub>`;
          
          const comments = await github.rest.issues.listComments({
            owner, repo, issue_number: pr
          });
          
          const existing = comments.data.find(c => c.body && c.body.includes('Automated CI Summary'));
          
          if (existing) {
            await github.rest.issues.updateComment({
              owner, repo, comment_id: existing.id, body
            });
          } else {
            await github.rest.issues.createComment({
              owner, repo, issue_number: pr, body
            });
          }
