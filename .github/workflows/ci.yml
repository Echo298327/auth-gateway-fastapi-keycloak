name: CI

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read
  pull-requests: write

jobs:
  # ============================================
  # Step 1: Lint
  # ============================================
  lint:
    name: Lint
    uses: ./.github/workflows/lint.yml

  # ============================================
  # Step 2: Security
  # ============================================
  security:
    name: Security
    needs: lint
    uses: ./.github/workflows/security.yml

  # ============================================
  # Step 3: Tests
  # ============================================
  tests:
    name: Tests
    needs: security
    uses: ./.github/workflows/tests.yml

  # ============================================
  # Step 4: Post Summary
  # ============================================
  summary:
    name: ğŸ“Š Summary
    needs: [lint, security, tests]
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: Post CI Summary
      uses: actions/github-script@v7
      with:
        script: |
          const pr = context.payload.pull_request.number;
          const { owner, repo } = context.repo;
          
          const lint = '${{ needs.lint.result }}';
          const security = '${{ needs.security.result }}';
          const tests = '${{ needs.tests.result }}';
          
          const results = [
            { name: 'ğŸ” Lint', status: lint },
            { name: 'ğŸ›¡ï¸ Security', status: security },
            { name: 'ğŸ§ª Tests', status: tests }
          ];
          
          const passed = results.filter(r => r.status === 'success').length;
          const failed = results.filter(r => r.status === 'failure').length;
          const total = results.length;
          
          const getIcon = (status) => {
            if (status === 'success') return 'âœ…';
            if (status === 'failure') return 'âŒ';
            if (status === 'skipped') return 'â­ï¸';
            return 'â³';
          };
          
          let body = '';
          
          if (failed === 0) {
            body = `## âœ… All CI Checks Passed!

| Status | Check |
|:------:|-------|
`;
            for (const r of results) {
              body += `| ${getIcon(r.status)} | ${r.name} |\n`;
            }
            
            body += `
---

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                             â”‚
â”‚   ğŸš€  READY TO MERGE                        â”‚
â”‚                                             â”‚
â”‚   âœ“ Lint        Â· No unused imports         â”‚
â”‚   âœ“ Security    Â· No vulnerabilities        â”‚
â”‚   âœ“ Tests       Â· All tests passing         â”‚
â”‚                                             â”‚
â”‚   Checks: ${passed}/${total} passed                       â”‚
â”‚                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
\`\`\`

> ğŸ‰ **This PR is ready for review and merge!**
`;
          } else {
            body = `## âŒ CI Checks Failed

| Status | Check |
|:------:|-------|
`;
            for (const r of results) {
              body += `| ${getIcon(r.status)} | ${r.name} |\n`;
            }
            
            body += `
---

> âš ï¸ **Please fix the failing checks before merging.**
`;
          }
          
          body += `\n<sub>ğŸ¤– Automated CI Summary</sub>`;
          
          // Find/update existing comment
          const comments = await github.rest.issues.listComments({
            owner, repo, issue_number: pr
          });
          
          const existing = comments.data.find(c => c.body && c.body.includes('ğŸ¤– Automated CI Summary'));
          
          if (existing) {
            await github.rest.issues.updateComment({
              owner, repo, comment_id: existing.id, body
            });
          } else {
            await github.rest.issues.createComment({
              owner, repo, issue_number: pr, body
            });
          }
